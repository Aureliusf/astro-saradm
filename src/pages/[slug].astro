---
export const prerender = true;

import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import imageUrlBuilder from "@sanity/image-url";
import type { SanityImageSource } from "@sanity/image-url/lib/types/types";
import { PortableText } from "astro-portabletext";
import MainLayout from '../layouts/main.astro';
import Footer from '../components/Footer.astro';
import { Masonry } from 'astro-masonry';

// This function runs at build time to find all the paths to generate.
export async function getStaticPaths() {
  const SLUGS_QUERY = `*[_type == "post" && defined(slug.current)]{"slug": slug.current}`;
  const slugs = await sanityClient.fetch<Array<{ slug: string }>>(SLUGS_QUERY);
  
  return slugs.map(({ slug }) => {
    return {
      params: { slug: slug }
    };
  });
}

// The code below runs for each generated page.
// Astro passes the `slug` from `getStaticPaths` in `Astro.params`.
const { slug } = Astro.params;

const POST_QUERY = `*[_type == "post" && slug.current == $slug][0]{
  ...,
  "tags": tags[]->name
}`;
const post = await sanityClient.fetch<SanityDocument>(POST_QUERY, { slug });

// Helper functions
const builder = imageUrlBuilder(sanityClient);
function urlFor(source: SanityImageSource) {
  return builder.image(source);
}
function generateImageProps(image: SanityImageSource) {
  const base = urlFor(image).quality(90).auto('format');
  return {
    src: base.width(800).url(),
    srcset: [400, 800, 1200]
      .map(w => `${base.width(w).url()} ${w}w`)
      .join(', '),
    sizes: '(min-width: 768px) 33vw, 50vw',
  };
}

// Conditional link logic
const hasAssistingTag = post.tags?.includes('Asistente');
const backLinkUrl = hasAssistingTag ? '/assisting' : '/posts';
const backLinkText = hasAssistingTag ? 'Todas mis colaboraciones' : 'Todos mis proyectos';

// Conditional format for Runways
const isRunway = post.tags?.includes('Pasarela');
const creditsSection = isRunway ? 'Enlaces de Interés' : 'Créditos';
---

<MainLayout title={post.title}>
  <main class="container mx-auto min-h-screen px-4 md:px-8 pt-2 md:pt-4 pb-4 md:pb-8 flex flex-col gap-4 bg-white">
    <a href={backLinkUrl} class="title-font text-[#220d0c] md:text-xl  text-left hover:underline">&larr;{backLinkText}</a>
    <h1>{post.title}</h1>
    <div class="text-center text-2xl md:text-3xl gap-1">
      <p class="title-font text-[#541409] opacity-60">{new Date(post.publishedAt).getFullYear()}</p>
    </div>
    <div class="text-center text-xl md:text-2xl text-[#220d0c]">
      {Array.isArray(post.body) && <PortableText value={post.body} />}
    </div>
    {post.gallery && Array.isArray(post.gallery) && post.gallery.length > 0 && (
      <div class="py-8">
        <Masonry breakAt={{ 0: 2, 768: 3 }} gap={4}> // Masonry broken :(

          {post.gallery.map((imageWithAlt: { image: SanityImageSource; alt?: string }) => {
            if (!imageWithAlt.image) return null;
            const imageProps = generateImageProps(imageWithAlt.image);
            return (
              <img
                src={imageProps.src}
                srcset={imageProps.srcset}
                alt={imageWithAlt.alt || ""}
                class="w-full h-auto"
                loading="lazy"
                decoding="async"
              />
            );
          })}
        </Masonry>
      </div>
    )}
        
    {post.credits && post.credits.length > 0 && (
      <>
        <h2 class="main-title-font text-center text-2xl md:text-3xl font-bold text-[#541409] ">{creditsSection}</h2>
        <div class="text-base md:text-xl text-[#220d0c]">
          <PortableText value={post.credits} />
        </div>
      </>
    )}
    <a href={backLinkUrl} class="title-font text-[#220d0c] md:text-xl  text-right hover:underline">&larr;{backLinkText}</a>
  </main>
</MainLayout>
<Footer />

